name: move-v1-tag

on:
  push:
    tags:
      - "v1.*.*"

permissions:
  contents: write

jobs:
  move-v1:
    runs-on: ubuntu-latest
    steps:
      - name: Move v1 tag to latest v1.x.y release tag commit
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
          REPOSITORY: ${{ github.repository }}
          SHA: ${{ github.sha }}
        run: |
          set -euo pipefail
          ref_name="tags/v1"
          if gh api "repos/$REPOSITORY/git/ref/$ref_name" >/dev/null 2>&1; then
            gh api --method PATCH "repos/$REPOSITORY/git/refs/$ref_name" -f sha="$SHA" -f force=true >/dev/null
            echo "Updated refs/$ref_name -> $SHA"
          else
            gh api --method POST "repos/$REPOSITORY/git/refs" -f ref="refs/$ref_name" -f sha="$SHA" >/dev/null
            echo "Created refs/$ref_name -> $SHA"
          fi
